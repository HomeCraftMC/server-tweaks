---
when:
  - event: push
    branch: main
  - event: tag
    tag: "v*"
  - event: manual

steps:
  build-snapshot:
    image: maven:3.9-eclipse-temurin-21
    when:
      - event: push
        branch: main
    commands:
      - mvn clean package -DskipTests -q
      - cp target/ServerTweaks-*.jar target/ServerTweaks-SNAPSHOT.jar

  upload-snapshot:
    image: minio/mc:latest
    when:
      - event: push
        branch: main
    environment:
      S3_ACCESS_KEY:
        from_secret: s3_access_key
      S3_SECRET_KEY:
        from_secret: s3_secret_key
    commands:
      - mc alias set minio https://s3.psalkowski.pl "$S3_ACCESS_KEY" "$S3_SECRET_KEY"
      - mc cp target/ServerTweaks-SNAPSHOT.jar minio/minecraft-plugins/ServerTweaks-SNAPSHOT.jar
      - echo "Uploaded SNAPSHOT to https://s3.psalkowski.pl/minecraft-plugins/ServerTweaks-SNAPSHOT.jar"

  build-release:
    image: maven:3.9-eclipse-temurin-21
    when:
      - event: tag
    commands:
      - VERSION=${CI_COMMIT_TAG#v}
      - echo "Building release version $VERSION"
      - mvn versions:set -DnewVersion=$VERSION -DgenerateBackupPoms=false -q
      - mvn clean package -DskipTests -q
      - cp target/ServerTweaks-${VERSION}.jar target/ServerTweaks.jar
      - cp target/ServerTweaks-${VERSION}.jar target/ServerTweaks-${VERSION}.jar

  upload-release:
    image: minio/mc:latest
    when:
      - event: tag
    environment:
      S3_ACCESS_KEY:
        from_secret: s3_access_key
      S3_SECRET_KEY:
        from_secret: s3_secret_key
    commands:
      - VERSION=${CI_COMMIT_TAG#v}
      - mc alias set minio https://s3.psalkowski.pl "$S3_ACCESS_KEY" "$S3_SECRET_KEY"
      - mc cp target/ServerTweaks.jar minio/minecraft-plugins/ServerTweaks.jar
      - mc cp target/ServerTweaks-${VERSION}.jar minio/minecraft-plugins/ServerTweaks-${VERSION}.jar
      - echo "Uploaded release to https://s3.psalkowski.pl/minecraft-plugins/ServerTweaks.jar"
      - echo "Uploaded versioned to https://s3.psalkowski.pl/minecraft-plugins/ServerTweaks-${VERSION}.jar"

  bump-version:
    image: maven:3.9-eclipse-temurin-21
    when:
      - event: tag
    environment:
      GITHUB_TOKEN:
        from_secret: github_token
    commands:
      - apt-get update && apt-get install -y git
      - VERSION=${CI_COMMIT_TAG#v}
      - IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
      - NEXT_MINOR=$((MINOR + 1))
      - NEXT_VERSION="${MAJOR}.${NEXT_MINOR}.0-SNAPSHOT"
      - echo "Bumping version to $NEXT_VERSION"
      - git config --global user.email "ci@homecraftmc.com"
      - git config --global user.name "HomeCraft CI"
      - git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/HomeCraftMC/server-tweaks.git
      - git fetch origin main
      - git checkout main
      - mvn versions:set -DnewVersion=$NEXT_VERSION -DgenerateBackupPoms=false -q
      - git add pom.xml
      - git commit -m "Bump version to $NEXT_VERSION [skip ci]"
      - git push origin main
